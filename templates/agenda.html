{% extends 'base.html' %}

{% block navbar %}
<ul class="navbar-nav mr-auto">
    <li class="nav-item"><a class="nav-link" href="{{ url_for('agenda') }}">Agenda</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('profile') }}">Perfil</a></li>
    <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}">Logout</a></li>
    <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Cadastro</a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a class="dropdown-item" href="{{ url_for('especialidades') }}">Especialidades</a>
            <a class="dropdown-item" href="{{ url_for('listar_medicos') }}">Médicos</a>
            <a class="dropdown-item" href="{{ url_for('listar_salas') }}">Salas</a>
            <a class="dropdown-item" href="{{ url_for('listar_pacientes') }}">Pacientes</a>
        </div>
    </li>
</ul>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <header class="d-flex justify-content-between align-items-center">
        <h1>Bem-vindo à sua Agenda</h1>
    </header>
    <main>
        <div class="d-flex justify-content-between mb-3">
            <button id="btn-calendario" class="btn btn-primary">Calendário</button>
            <button id="btn-lista" class="btn btn-secondary">Lista</button>
        </div>

        <div class="row">
            <div id="calendario-container" class="col-md-8">
                <div id='calendar'></div>
            </div>
            <div id="sideBarContainer" class="col-md-4 d-none">
                <div class="card">
                    <div class="card-header text-center">
                        <h3 id="sideBarTitle" class="mb-3">Agendamentos</h3>
                        <button class="btn btn-success" data-toggle="modal" data-target="#cadastrarModal">Novo Agendamento</button>
                    </div>
                    <div class="card-body" id="sideBar"></div>
                </div>
            </div>
        </div>

        <div id="lista-container" class="d-none">
            <h2>Lista de Compromissos</h2>
            {% if agendamentos %}
                <ul class="list-group">
                    {% for agendamento in agendamentos %}
                        <li class="list-group-item">
                            {{ agendamento.data }} {{ agendamento.hora }} -
                            Sala: {{ agendamento.sala }}, Médico: {{ agendamento.medico }}, Paciente: {{ agendamento.paciente }}
                            <a href="{{ url_for('editar_agendamento', id=agendamento.id) }}" class="btn btn-sm btn-warning">Editar</a>
                            <form action="{{ url_for('excluir_agendamento', id=agendamento.id) }}" method="POST" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-danger">Excluir</button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Você ainda não possui compromissos agendados.</p>
            {% endif %}
        </div>
    </main>
    <footer class="mt-5">
        <p>&copy; 2024. Todos os direitos reservados.</p>
    </footer>
</div>

<!-- Modal para cadastrar novo agendamento -->
<div class="modal fade" id="cadastrarModal" tabindex="-1" role="dialog" aria-labelledby="cadastrarModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cadastrarModalLabel">Cadastrar Novo Agendamento</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form method="POST" action="{{ url_for('cadastrar_agendamento') }}">
        <div class="modal-body">
          <div class="form-group">
            <label for="data_inicio">Data</label>
            <input type="date" class="form-control" id="data_inicio" name="data" required>
          </div>
          <div class="form-group">
            <label for="hora_inicio">Hora</label>
            <input type="time" class="form-control" id="hora_inicio" name="hora" required>
          </div>
          <div class="form-group">
            <label for="sala_id">Sala</label>
            <select class="form-control" id="sala_id" name="sala_id" required>
              <option value="" disabled selected>Selecione uma sala</option>
              {% for sala in salas %}
                <option value="{{ sala.id }}">{{ sala.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="medico_id">Médico</label>
            <select class="form-control" id="medico_id" name="medico_id" required>
              <option value="" disabled selected>Selecione um médico</option>
              {% for medico in medicos %}
                <option value="{{ medico.id }}">{{ medico.nome }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="paciente_id">Paciente</label>
            <select class="form-control" id="paciente_id" name="paciente_id" required>
              <option value="" disabled selected>Selecione um paciente</option>
              {% for paciente in pacientes %}
                <option value="{{ paciente.id_paciente }}">{{ paciente.nome }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
          <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('btn-calendario').addEventListener('click', function() {
    document.getElementById('calendario-container').classList.remove('d-none');
    document.getElementById('lista-container').classList.add('d-none');
});
document.getElementById('btn-lista').addEventListener('click', function() {
    document.getElementById('calendario-container').classList.add('d-none');
    document.getElementById('lista-container').classList.remove('d-none');
});

$(document).ready(function() {
    $.get('/agenda/contagem', function(contagens) {
        var eventSources = contagens.map(function(item) {
            return {
                start: item.data,
                title: `${item.num_agendamentos} C`
            };
        });

        $('#calendar').fullCalendar({
            locale: 'pt',
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            events: eventSources,
            dayClick: function(date, jsEvent, view) {
                var selectedDate = date.format('YYYY-MM-DD');
                var formattedDate = date.format('DD/MM/YYYY');

                $.ajax({
                    url: '/agendamentos/' + selectedDate,
                    method: 'GET',
                    success: function(data) {
                        var sideBar = $('#sideBar');
                        sideBar.html('');

                        if (!data || !Array.isArray(data) || data.length === 0) {
                            sideBar.append('<p>Nenhum agendamento.</p>');
                        } else {
                            data.forEach(function(agendamento) {
                                sideBar.append(`
                                    <p>
                                        Médico: ${agendamento.medico}<br>
                                        Hora: ${agendamento.hora}<br>
                                        Sala: ${agendamento.sala}<br>
                                        Paciente: ${agendamento.paciente}
                                    </p>
                                `);
                            });
                        }

                        $('#sideBarTitle').text(' Agendamentos ' + formattedDate);
                        $('#cadastrarModal #data_inicio').val(selectedDate);
                        $('#sideBarContainer').removeClass('d-none');

                        // Limpando a seleção anterior
                        $('#calendar').find('.fc-day, .fc-event-container').removeClass('selected-day');
                        // Adicionando a classe ao dia clicado
                        $(jsEvent.currentTarget).closest('.fc-day, .fc-event-container').addClass('selected-day');
                    },
                    error: function() {
                        console.error('Erro ao buscar agendamentos.');
                        $('#sideBar').html('<p>Erro ao buscar agendamentos.</p>');
                        $('#sideBarContainer').removeClass('d-none');
                    }
                });
            }
        });
    }).fail(function() {
        console.error('Falha ao carregar contagens de agendamentos.');
    });

    $('#cadastrarModal').on('show.bs.modal', function(e) {
        $.get('/agendamento/cadastrar', function(data) {
            $('#medico_id').html('');
            $('#sala_id').html('');
            $('#paciente_id').html('');

            data.medicos.forEach(function(medico) {
                $('#medico_id').append(new Option(medico.nome, medico.id));
            });
            data.salas.forEach(function(sala) {
                $('#sala_id').append(new Option(sala.nome, sala.id));
            });
            data.pacientes.forEach(function(paciente) {
                $('#paciente_id').append(new Option(paciente.nome, paciente.id_paciente));
            });
        }).fail(function() {
            console.error('Erro ao buscar dados para cadastro');
        });
    });

    $('#btn-calendario').click(function() {
        $('#calendario-container').removeClass('d-none');
        $('#lista-container').addClass('d-none');
    });

    $('#btn-lista').click(function() {
        $('#calendario-container').addClass('d-none');
        $('#lista-container').removeClass('d-none');
    });
});
</script>
{% endblock %}
